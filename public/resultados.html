<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Resultados Guardados - Quiz F√≠sica</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 2rem;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 12px;
        padding: 2rem;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      }

      h1 {
        color: #667eea;
        margin-bottom: 0.5rem;
      }

      .subtitle {
        color: #666;
        margin-bottom: 2rem;
      }

      .actions {
        display: flex;
        gap: 1rem;
        margin-bottom: 2rem;
        flex-wrap: wrap;
      }

      button {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 6px;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 600;
      }

      .btn-primary {
        background: #667eea;
        color: white;
      }

      .btn-primary:hover {
        background: #5568d3;
        transform: translateY(-2px);
      }

      .btn-secondary {
        background: #68c3c0;
        color: white;
      }

      .btn-secondary:hover {
        background: #56a3a0;
        transform: translateY(-2px);
      }

      .btn-danger {
        background: #ff6b6b;
        color: white;
      }

      .btn-danger:hover {
        background: #ff5252;
        transform: translateY(-2px);
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
      }

      th,
      td {
        padding: 1rem;
        text-align: left;
        border-bottom: 1px solid #eee;
      }

      th {
        background: #f8f9fa;
        font-weight: 600;
        color: #333;
      }

      tr:hover {
        background: #f8f9fa;
      }

      .nota {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-weight: 600;
      }

      .nota-5 {
        background: #ffd700;
        color: #333;
      }
      .nota-4 {
        background: #44c7f4;
        color: white;
      }
      .nota-3 {
        background: #ffa500;
        color: white;
      }
      .nota-2,
      .nota-1 {
        background: #ff6b6b;
        color: white;
      }

      .empty-state {
        text-align: center;
        padding: 3rem;
        color: #999;
      }

      .empty-state svg {
        width: 100px;
        height: 100px;
        margin-bottom: 1rem;
        opacity: 0.3;
      }

      .stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
      }

      .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1.5rem;
        border-radius: 8px;
        text-align: center;
      }

      .stat-value {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
      }

      .stat-label {
        font-size: 0.9rem;
        opacity: 0.9;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üìä Resultados Guardados Localmente</h1>
      <p class="subtitle">
        Respaldo de los resultados del quiz (guardados en el navegador)
      </p>

      <div class="stats" id="stats"></div>

      <div class="actions">
        <button class="btn-primary" onclick="loadResults()">üîÑ Actualizar</button>
        <button class="btn-secondary" onclick="exportCSV()">üì• Exportar CSV</button>
        <button class="btn-danger" onclick="clearResults()">üóëÔ∏è Limpiar Todo</button>
        <button class="btn-primary" onclick="window.location.href='/'">
          üè† Volver al Juego
        </button>
      </div>

      <div id="resultsContainer"></div>
    </div>

    <script type="module">
      import { getLocalResults, exportLocalResultsToCSV } from './js/sheets.js';

      window.loadResults = function () {
        const results = getLocalResults();
        const container = document.getElementById('resultsContainer');
        const statsContainer = document.getElementById('stats');

        if (results.length === 0) {
          container.innerHTML = `
          <div class="empty-state">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
            </svg>
            <h3>No hay resultados guardados</h3>
            <p>Los resultados aparecer√°n aqu√≠ cuando los estudiantes completen el quiz</p>
          </div>
        `;
          statsContainer.innerHTML = '';
          return;
        }

        // Calcular estad√≠sticas
        const totalResultados = results.length;
        const promedioNota = (
          results.reduce((sum, r) => sum + (r.nota || 0), 0) / totalResultados
        ).toFixed(1);
        const promedioPorcentaje = (
          results.reduce((sum, r) => sum + (r.porcentaje || 0), 0) / totalResultados
        ).toFixed(1);
        const aprobados = results.filter((r) => r.nota >= 3).length;

        statsContainer.innerHTML = `
        <div class="stat-card">
          <div class="stat-value">${totalResultados}</div>
          <div class="stat-label">Total Resultados</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${promedioNota}/5</div>
          <div class="stat-label">Nota Promedio</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${promedioPorcentaje}%</div>
          <div class="stat-label">Acierto Promedio</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${aprobados}</div>
          <div class="stat-label">Aprobados (‚â•3)</div>
        </div>
      `;

        // Crear tabla
        container.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Nombre</th>
              <th>Grado</th>
              <th>Correctas</th>
              <th>Porcentaje</th>
              <th>Nota</th>
            </tr>
          </thead>
          <tbody>
            ${results
              .map(
                (r) => `
              <tr>
                <td>${new Date(r.timestamp).toLocaleString('es-CO')}</td>
                <td>${r.nombre || 'An√≥nimo'}</td>
                <td>${r.grado || 'N/A'}</td>
                <td>${r.correctas || 0}/${r.total || 0}</td>
                <td>${(r.porcentaje || 0).toFixed(1)}%</td>
                <td><span class="nota nota-${r.nota || 0}">${r.nota || 0}/5</span></td>
              </tr>
            `,
              )
              .join('')}
          </tbody>
        </table>
      `;
      };

      window.exportCSV = function () {
        const csv = exportLocalResultsToCSV();
        if (!csv) {
          alert('No hay resultados para exportar');
          return;
        }

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);

        link.setAttribute('href', url);
        link.setAttribute(
          'download',
          `resultados_quiz_${new Date().toISOString().split('T')[0]}.csv`,
        );
        link.style.visibility = 'hidden';

        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        alert('‚úÖ Archivo CSV descargado correctamente');
      };

      window.clearResults = function () {
        if (
          !confirm(
            '‚ö†Ô∏è ¬øEst√°s seguro de que quieres eliminar TODOS los resultados guardados localmente?\n\nEsta acci√≥n no se puede deshacer.',
          )
        ) {
          return;
        }

        let deletedCount = 0;
        const keysToDelete = [];

        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key && key.startsWith('quiz_result_')) {
            keysToDelete.push(key);
          }
        }

        keysToDelete.forEach((key) => {
          localStorage.removeItem(key);
          deletedCount++;
        });

        alert(`‚úÖ Se eliminaron ${deletedCount} resultados`);
        loadResults();
      };

      // Cargar resultados al inicio
      loadResults();
    </script>
  </body>
</html>
